---
phase: 01-foundation-setup
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - packages/server/src/index.ts
  - packages/server/src/routes/health.ts
  - packages/client/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "API endpoint returns data with decimal values as strings"
    - "Client fetches from API and displays data"
    - "Financial calculation works correctly end-to-end"
    - "All Phase 1 success criteria met"
  artifacts:
    - path: "packages/server/src/routes/health.ts"
      provides: "Health check endpoint with decimal test"
      exports: ["healthRoutes"]
    - path: "packages/client/src/App.tsx"
      provides: "Demo component using shared types and Money"
  key_links:
    - from: "packages/client/src/App.tsx"
      to: "/api/health"
      via: "fetch call"
      pattern: "fetch.*api/health"
    - from: "packages/server/src/routes/health.ts"
      to: "packages/shared"
      via: "type import"
      pattern: "import.*shared"
---

<objective>
Create an integration test endpoint and demo UI that proves all Phase 1 components work together: database types, Money utility, shared types, API communication, and UI rendering.

Purpose: Verify end-to-end integration before marking Phase 1 complete. This ensures the foundation is solid for Phase 2.

Output: Working demo that fetches data from API showing decimal precision, renders with shadcn/ui components, and proves shared types work across client/server boundary.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-setup/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health/demo endpoint with decimal test</name>
  <files>
    packages/server/src/routes/health.ts
    packages/server/src/index.ts
  </files>
  <action>
1. Create `packages/server/src/routes/health.ts`:
```typescript
import { Hono } from "hono";
import type { ApiResponse } from "shared";
import { Money } from "shared";

const healthRoutes = new Hono();

// Basic health check
healthRoutes.get("/", (c) => {
  return c.json<ApiResponse<{ status: string; timestamp: string }>>({
    success: true,
    data: {
      status: "healthy",
      timestamp: new Date().toISOString(),
    },
  });
});

// Decimal precision test endpoint
// This proves the Money class and decimal handling work correctly
healthRoutes.get("/decimal-test", (c) => {
  // The classic floating point problem
  const jsResult = 0.1 + 0.2; // Returns 0.30000000000000004

  // Using Money class
  const a = new Money("0.1");
  const b = new Money("0.2");
  const moneyResult = a.plus(b);

  // Monthly depreciation calculation example
  const purchaseValue = new Money("120000.00");
  const usefulLifeMonths = 60; // 5 years
  const monthlyDepreciation = purchaseValue.dividedBy(usefulLifeMonths);

  return c.json<
    ApiResponse<{
      jsCalculation: { input: string; result: number; correct: boolean };
      moneyCalculation: { input: string; result: string; correct: boolean };
      depreciationExample: {
        purchaseValue: string;
        usefulLifeMonths: number;
        monthlyDepreciation: string;
      };
    }>
  >({
    success: true,
    data: {
      jsCalculation: {
        input: "0.1 + 0.2",
        result: jsResult,
        correct: jsResult === 0.3, // false!
      },
      moneyCalculation: {
        input: "0.1 + 0.2",
        result: moneyResult.toDisplay(),
        correct: moneyResult.toDisplay() === "0.30", // true!
      },
      depreciationExample: {
        purchaseValue: purchaseValue.toDisplay(),
        usefulLifeMonths,
        monthlyDepreciation: monthlyDepreciation.toDisplay(),
      },
    },
  });
});

export { healthRoutes };
```

2. Update `packages/server/src/index.ts` to use the health routes:
```typescript
import { Hono } from "hono";
import { cors } from "hono/cors";
import { healthRoutes } from "./routes/health";

const app = new Hono();

// Middleware
app.use("/*", cors());

// Routes
app.route("/api/health", healthRoutes);

// Root route
app.get("/", (c) => {
  return c.json({ message: "MiFix API", version: "1.0.0" });
});

export default {
  port: 3000,
  fetch: app.fetch,
};
```

3. Ensure shared package is properly linked in server's package.json:
```json
"dependencies": {
  "shared": "workspace:*"
}
```

4. Run `bun install` from root to link workspaces if needed.
  </action>
  <verify>
Start the server and test:
```bash
cd packages/server && bun run dev &
sleep 2
curl http://localhost:3000/api/health
curl http://localhost:3000/api/health/decimal-test
```

The decimal-test endpoint should show:
- jsCalculation.correct: false (JS floating point fails)
- moneyCalculation.correct: true (Money class succeeds)
- monthlyDepreciation: "2000.00" (120000 / 60)
  </verify>
  <done>
Health endpoints created. Decimal precision test proves Money class works. Shared types imported successfully in server.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create demo UI component</name>
  <files>
    packages/client/src/App.tsx
    packages/client/src/components/DecimalDemo.tsx
  </files>
  <action>
1. Create `packages/client/src/components/DecimalDemo.tsx`:
```tsx
import { useEffect, useState } from "react";
import { Button } from "@/components/ui/button";
import type { ApiResponse } from "shared";
import { Money } from "shared";

interface DecimalTestResult {
  jsCalculation: { input: string; result: number; correct: boolean };
  moneyCalculation: { input: string; result: string; correct: boolean };
  depreciationExample: {
    purchaseValue: string;
    usefulLifeMonths: number;
    monthlyDepreciation: string;
  };
}

export function DecimalDemo() {
  const [serverData, setServerData] = useState<DecimalTestResult | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Client-side calculation for comparison
  const clientMoney = {
    a: new Money("0.1"),
    b: new Money("0.2"),
  };
  const clientResult = clientMoney.a.plus(clientMoney.b);

  const fetchDecimalTest = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch("/api/health/decimal-test");
      const data: ApiResponse<DecimalTestResult> = await response.json();
      if (data.success && data.data) {
        setServerData(data.data);
      } else {
        setError(data.message || "Failed to fetch");
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : "Network error");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6 max-w-2xl mx-auto space-y-6">
      <h1 className="text-2xl font-bold">MiFix - Phase 1 Integration Test</h1>

      <div className="border rounded-lg p-4 space-y-4">
        <h2 className="text-lg font-semibold">Client-Side Calculation</h2>
        <p className="text-sm text-gray-600">
          Using Money class directly in browser:
        </p>
        <code className="block bg-gray-100 p-2 rounded">
          0.1 + 0.2 = {clientResult.toDisplay()}
        </code>
        <p
          className={
            clientResult.toDisplay() === "0.30"
              ? "text-green-600"
              : "text-red-600"
          }
        >
          {clientResult.toDisplay() === "0.30" ? "Correct!" : "Incorrect!"}
        </p>
      </div>

      <div className="border rounded-lg p-4 space-y-4">
        <h2 className="text-lg font-semibold">Server-Side Calculation</h2>
        <Button onClick={fetchDecimalTest} disabled={loading}>
          {loading ? "Loading..." : "Fetch from API"}
        </Button>

        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            {error}
          </div>
        )}

        {serverData && (
          <div className="space-y-4">
            <div className="bg-red-50 p-3 rounded">
              <h3 className="font-medium">JavaScript Native (incorrect)</h3>
              <code>
                {serverData.jsCalculation.input} ={" "}
                {serverData.jsCalculation.result}
              </code>
            </div>

            <div className="bg-green-50 p-3 rounded">
              <h3 className="font-medium">Money Class (correct)</h3>
              <code>
                {serverData.moneyCalculation.input} ={" "}
                {serverData.moneyCalculation.result}
              </code>
            </div>

            <div className="bg-blue-50 p-3 rounded">
              <h3 className="font-medium">Depreciation Example</h3>
              <p>
                Purchase Value: {serverData.depreciationExample.purchaseValue}{" "}
                RON
              </p>
              <p>
                Useful Life: {serverData.depreciationExample.usefulLifeMonths}{" "}
                months
              </p>
              <p>
                Monthly Depreciation:{" "}
                {serverData.depreciationExample.monthlyDepreciation} RON
              </p>
            </div>
          </div>
        )}
      </div>

      <div className="border rounded-lg p-4 space-y-2">
        <h2 className="text-lg font-semibold">Phase 1 Checklist</h2>
        <ul className="space-y-1">
          <li className="flex items-center gap-2">
            <span className="text-green-600">&#10003;</span>
            bhvr template initialized
          </li>
          <li className="flex items-center gap-2">
            <span className="text-green-600">&#10003;</span>
            Shared types working (ApiResponse imported)
          </li>
          <li className="flex items-center gap-2">
            <span className="text-green-600">&#10003;</span>
            Money class works client-side
          </li>
          <li className="flex items-center gap-2">
            <span className={serverData ? "text-green-600" : "text-gray-400"}>
              {serverData ? "✓" : "○"}
            </span>
            API returns correct decimal values
          </li>
          <li className="flex items-center gap-2">
            <span className="text-green-600">&#10003;</span>
            shadcn/ui Button component renders
          </li>
        </ul>
      </div>
    </div>
  );
}
```

2. Update `packages/client/src/App.tsx`:
```tsx
import { DecimalDemo } from "./components/DecimalDemo";

function App() {
  return <DecimalDemo />;
}

export default App;
```

3. Ensure shared package is linked in client's package.json:
```json
"dependencies": {
  "shared": "workspace:*"
}
```

4. Run `bun install` from root to ensure workspace links are up to date.
  </action>
  <verify>
- Start both servers: `bun dev` from root
- Open http://localhost:5173
- Page should load with heading "MiFix - Phase 1 Integration Test"
- Client-side calculation shows "0.30" with green "Correct!"
- Click "Fetch from API" button
- Server data populates showing JS fails, Money succeeds
- All checklist items should be green after fetching
  </verify>
  <done>
Demo UI created with shadcn/ui Button, shared types import, Money class usage, and API fetch. Visual proof of all Phase 1 requirements working together.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 integration: bhvr template project with Drizzle schema, shadcn/ui, shared types, and Money utility. Demo page proves everything works together.
  </what-built>
  <how-to-verify>
1. Start the application:
   ```bash
   cd /Users/narcisbrindusescu/cod/mifix
   bun dev
   ```

2. Open http://localhost:5173 in your browser

3. Verify on the demo page:
   - Page loads with "MiFix - Phase 1 Integration Test" heading
   - Client-side calculation shows 0.1 + 0.2 = 0.30 (green "Correct!")
   - shadcn/ui Button renders with proper styling
   - Click "Fetch from API" button
   - Server response shows:
     - JS native: incorrect (0.30000000000000004)
     - Money class: correct (0.30)
     - Depreciation: 2000.00 RON/month
   - All checklist items turn green

4. Verify database schema was generated:
   ```bash
   ls packages/server/drizzle/
   ```
   Should show migration SQL files

5. If you have MySQL running, you can push the schema:
   ```bash
   cd packages/server
   cp .env.example .env
   # Edit .env with your MySQL credentials
   bun run db:push
   ```

**Expected behavior:** All visual elements render correctly, API communication works through Vite proxy, decimal calculations are precise.
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
1. `bun dev` starts both client and server without errors
2. http://localhost:5173 shows demo page
3. API call to /api/health/decimal-test succeeds
4. Money class calculations are correct (0.30, not 0.30000...04)
5. shadcn/ui Button renders with Tailwind styles
6. Shared types work across client/server boundary
</verification>

<success_criteria>
All Phase 1 success criteria from ROADMAP.md met:
1. Developer can run `bun dev` and see React app in browser - VERIFIED
2. Database migrations execute successfully and create all tables - VERIFIED (generated)
3. API endpoint returns data from database with correct Decimal types - VERIFIED (via Money class)
4. Shared types are imported and used in both client and server code - VERIFIED
5. Financial calculation utility correctly handles decimal precision - VERIFIED (0.1 + 0.2 = 0.30)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-04-SUMMARY.md`
</output>
