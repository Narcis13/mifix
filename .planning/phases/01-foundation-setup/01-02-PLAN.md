---
phase: 01-foundation-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/server/package.json
  - packages/server/src/db/index.ts
  - packages/server/src/db/schema.ts
  - packages/server/drizzle.config.ts
  - packages/server/.env
  - packages/server/.env.example
autonomous: true

must_haves:
  truths:
    - "Database connection pool initializes without error"
    - "Schema defines all nomenclator tables with correct decimal precision"
    - "Migrations can be generated and pushed to database"
  artifacts:
    - path: "packages/server/src/db/index.ts"
      provides: "Database connection with Drizzle"
      exports: ["db"]
      min_lines: 10
    - path: "packages/server/src/db/schema.ts"
      provides: "Drizzle schema definitions"
      contains: "decimal"
      min_lines: 50
    - path: "packages/server/drizzle.config.ts"
      provides: "Drizzle Kit configuration"
      contains: "mysql"
  key_links:
    - from: "packages/server/src/db/index.ts"
      to: "packages/server/src/db/schema.ts"
      via: "schema import"
      pattern: 'import.*schema'
    - from: "packages/server/drizzle.config.ts"
      to: "packages/server/src/db/schema.ts"
      via: "schema path"
      pattern: 'schema.*db/schema'
---

<objective>
Set up MySQL database integration with Drizzle ORM including schema definitions for all nomenclator tables.

Purpose: Establish the database layer with proper decimal precision for financial values, enabling all future data operations.

Output: Working database connection with complete schema for gestiuni, locuri_folosinta, surse_finantare, conturi, clasificari, mijloace_fixe, tranzactii, and amortizari tables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-setup/01-RESEARCH.md
@spec.md (database schema reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Drizzle dependencies and configure database connection</name>
  <files>
    packages/server/package.json
    packages/server/src/db/index.ts
    packages/server/drizzle.config.ts
    packages/server/.env
    packages/server/.env.example
  </files>
  <action>
1. Add Drizzle ORM dependencies to server package:
   ```bash
   cd packages/server
   bun add drizzle-orm mysql2
   bun add -D drizzle-kit dotenv
   ```

2. Create `packages/server/.env.example` with template:
   ```
   DATABASE_URL=mysql://user:password@localhost:3306/mifix
   DB_HOST=localhost
   DB_PORT=3306
   DB_USER=root
   DB_PASSWORD=
   DB_NAME=mifix
   ```

3. Create `packages/server/.env` with actual local development values (gitignored)

4. Create `packages/server/src/db/index.ts`:
   - Import drizzle from "drizzle-orm/mysql2"
   - Import mysql from "mysql2/promise"
   - Import schema from "./schema"
   - Create connection pool using environment variables
   - Export db instance with schema mode

   Use mysql2 pool (NOT Bun native SQL - it doesn't support MySQL yet).
   Configure pool with connectionLimit: 10 for safety.

5. Create `packages/server/drizzle.config.ts`:
   - Use "dotenv/config" import for env vars
   - Set dialect: "mysql"
   - Point schema to "./src/db/schema.ts"
   - Set out to "./drizzle" for migrations
   - Use DATABASE_URL from environment

6. Add to .gitignore if not present: `packages/server/.env`
  </action>
  <verify>
- `cat packages/server/package.json | grep drizzle` shows drizzle-orm and drizzle-kit
- `cat packages/server/package.json | grep mysql2` shows mysql2 dependency
- `cat packages/server/drizzle.config.ts` shows mysql dialect config
- `cat packages/server/.env.example` shows DATABASE_URL template
  </verify>
  <done>
Drizzle ORM and mysql2 installed. Database connection configured with pool. Environment variables templated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create complete database schema</name>
  <files>
    packages/server/src/db/schema.ts
  </files>
  <action>
Create `packages/server/src/db/schema.ts` with the complete schema from spec.md:

**Import from drizzle-orm/mysql-core:**
mysqlTable, varchar, int, decimal, date, datetime, boolean, json, mysqlEnum, index

**Tables to create:**

1. **clasificari** - HG 2139/2004 classification catalog
   - cod (varchar 10, PRIMARY KEY)
   - denumire (varchar 500, NOT NULL)
   - grupa (varchar 5, NOT NULL) - I, II, III
   - durataNormalaMin (int, NOT NULL)
   - durataNormalaMax (int, NOT NULL)
   - cotaAmortizare (decimal 5,2)

2. **gestiuni** - Asset custodians
   - id (int, autoincrement, PRIMARY KEY)
   - cod (varchar 20, UNIQUE, NOT NULL)
   - denumire (varchar 200, NOT NULL)
   - responsabil (varchar 200)
   - activ (boolean, default true)
   - createdAt, updatedAt (datetime)

3. **locuri_folosinta** - Locations within gestiuni
   - id (int, autoincrement, PRIMARY KEY)
   - gestiuneId (int, FK to gestiuni.id, NOT NULL)
   - cod (varchar 20, NOT NULL)
   - denumire (varchar 200, NOT NULL)
   - activ (boolean, default true)
   - INDEX on gestiuneId

4. **surse_finantare** - Funding sources
   - id (int, autoincrement, PRIMARY KEY)
   - cod (varchar 20, UNIQUE, NOT NULL)
   - denumire (varchar 200, NOT NULL)
   - activ (boolean, default true)

5. **conturi** - Chart of accounts
   - id (int, autoincrement, PRIMARY KEY)
   - simbol (varchar 20, UNIQUE, NOT NULL)
   - denumire (varchar 300, NOT NULL)
   - tip (enum: 'activ', 'pasiv', 'bifunctional', NOT NULL)
   - amortizabil (boolean, default false)
   - contAmortizare (varchar 20)
   - activ (boolean, default true)

6. **mijloace_fixe** - Fixed assets (main entity)
   - All fields from spec.md section 2.2
   - Use decimal(15, 2) for ALL monetary values
   - Foreign keys to all nomenclator tables
   - Indexes on gestiuneId, clasificareCod, stare, dataAchizitie

7. **tranzactii** - Asset transactions
   - All fields from spec.md
   - Enum for tip: 'intrare', 'transfer', 'casare', 'declasare', 'reevaluare', 'modernizare', 'iesire'
   - Indexes on mijlocFixId, tip, dataOperare

8. **amortizari** - Monthly depreciation records
   - All fields from spec.md
   - Use decimal(15, 2) for valoareLunara, valoareCumulata, valoareRamasa
   - Composite index on (mijlocFixId, an, luna)

**Critical:** All monetary fields MUST use `decimal("field_name", { precision: 15, scale: 2 })` - never int or float.

Export all tables.
  </action>
  <verify>
- `cat packages/server/src/db/schema.ts | grep "decimal"` shows multiple decimal fields
- `cat packages/server/src/db/schema.ts | grep "precision: 15"` confirms financial precision
- `cat packages/server/src/db/schema.ts | grep "mysqlTable"` shows all 8 tables
- Schema file compiles: `cd packages/server && bunx tsc --noEmit src/db/schema.ts`
  </verify>
  <done>
Complete database schema with all 8 tables defined. Decimal precision (15,2) used for all monetary fields. Foreign keys and indexes configured.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate and verify migrations</name>
  <files>
    packages/server/drizzle/*
    packages/server/package.json (scripts)
  </files>
  <action>
1. Add database scripts to `packages/server/package.json`:
   ```json
   "scripts": {
     "db:generate": "drizzle-kit generate",
     "db:push": "drizzle-kit push",
     "db:migrate": "drizzle-kit migrate",
     "db:studio": "drizzle-kit studio"
   }
   ```

2. Ensure MySQL is running locally (or use Docker):
   - If MySQL not available, document the requirement
   - The schema can still be generated without database connection

3. Generate migrations:
   ```bash
   cd packages/server
   bun run db:generate
   ```
   This creates SQL files in `packages/server/drizzle/` directory.

4. Verify generated SQL:
   - Check that all tables are created
   - Check decimal columns have correct precision
   - Check foreign keys are defined

5. If MySQL is available, push schema:
   ```bash
   bun run db:push
   ```

   If MySQL is not available, skip this step - it can be done in Task 4 of integration plan.
  </action>
  <verify>
- `ls packages/server/drizzle/` shows migration files
- Migration SQL contains `DECIMAL(15,2)` for monetary columns
- `cat packages/server/package.json | grep "db:"` shows database scripts
  </verify>
  <done>
Database migrations generated. SQL files created for all tables with correct column types. Scripts added to package.json.
  </done>
</task>

</tasks>

<verification>
1. `bun run --cwd packages/server db:generate` completes without errors
2. Migration files exist in packages/server/drizzle/
3. Schema imports compile: `cd packages/server && bunx tsc --noEmit`
4. Decimal precision verified in generated SQL
</verification>

<success_criteria>
- Drizzle ORM and mysql2 installed in server package
- Database connection pool configured with environment variables
- Complete schema for all 8 tables defined
- All monetary fields use decimal(15,2)
- Migrations generated successfully
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-02-SUMMARY.md`
</output>
