---
phase: 06-rapoarte-autentificare
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/server/src/routes/rapoarte.ts
  - packages/server/src/index.ts
  - packages/shared/src/types/rapoarte.ts
autonomous: true

must_haves:
  truths:
    - "API returns complete asset data with transactions and depreciation for Fisa Mijlocului Fix"
    - "API returns balance by gestiune with totals for Balanta de Verificare"
    - "API returns transactions filtered by date range for Jurnal Acte"
    - "API returns depreciation summary by month for Situatie Amortizare"
    - "All report endpoints support filtering by gestiune and period"
  artifacts:
    - path: "packages/server/src/routes/rapoarte.ts"
      provides: "Report API endpoints"
      exports: ["rapoarteRoutes"]
    - path: "packages/shared/src/types/rapoarte.ts"
      provides: "Report type definitions"
      exports: ["FisaMijlocFix", "BalantaRow", "JurnalActRow", "SituatieAmortizareRow"]
  key_links:
    - from: "packages/server/src/routes/rapoarte.ts"
      to: "mijloaceFixe, tranzactii, amortizari"
      via: "database queries with joins"
      pattern: "db\\.select.*from.*mijloaceFixe"
    - from: "packages/server/src/index.ts"
      to: "rapoarteRoutes"
      via: "route registration"
      pattern: "app\\.route.*rapoarte"
---

<objective>
Create report API endpoints that aggregate data for Romanian accounting compliance reports: Fisa Mijlocului Fix, Balanta de Verificare, Jurnal Acte Operate, and Situatie Amortizare Lunara.

Purpose: RAP-01 through RAP-05 - Provide data endpoints for all required reports with filtering capabilities
Output: Four report API endpoints returning structured data for frontend display and printing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-rapoarte-autentificare/06-RESEARCH.md
@.planning/phases/06-rapoarte-autentificare/06-01-SUMMARY.md

# Existing API patterns
@packages/server/src/routes/mijloace-fixe.ts
@packages/server/src/routes/amortizari.ts
@packages/server/src/routes/operatiuni.ts
@packages/server/src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared report types</name>
  <files>
    packages/shared/src/types/rapoarte.ts
    packages/shared/src/index.ts
  </files>
  <action>
Create packages/shared/src/types/rapoarte.ts with TypeScript interfaces:

```typescript
// RAP-01: Fisa Mijlocului Fix
export interface FisaMijlocFix {
  // Asset core data
  id: number;
  numarInventar: string;
  denumire: string;
  descriere: string | null;

  // Classification
  clasificareCod: string;
  clasificareDenumire: string;
  clasificareGrupa: string;

  // Location
  gestiuneCod: string;
  gestiuneDenumire: string;
  locFolosintaCod: string | null;
  locFolosintaDenumire: string | null;

  // Financial
  sursaFinantareCod: string | null;
  sursaFinantareDenumire: string | null;
  contSimbol: string | null;
  contDenumire: string | null;

  // Acquisition
  dataAchizitie: string;
  documentAchizitie: string | null;
  tipDocumentCod: string | null;
  tipDocumentDenumire: string | null;
  furnizor: string | null;

  // Values (as strings for decimal precision)
  valoareInitiala: string;
  valoareInventar: string;
  valoareAmortizata: string;
  valoareRamasa: string;

  // Depreciation
  durataNormala: number;
  durataRamasa: number;
  cotaAmortizareLunara: string;
  eAmortizabil: boolean;
  dataIncepereAmortizare: string | null;
  dataFinalizareAmortizare: string | null;

  // Status
  stare: string;
  dataIesire: string | null;
  motivIesire: string | null;
  observatii: string | null;

  // History
  tranzactii: TranzactieRaport[];
  amortizari: AmortizareRaport[];
}

export interface TranzactieRaport {
  id: number;
  tip: string;
  dataOperare: string;
  documentNumar: string | null;
  gestiuneSursaCod: string | null;
  gestiuneDestinatieCod: string | null;
  locFolosintaSursaCod: string | null;
  locFolosintaDestinatieCod: string | null;
  valoareOperatie: string | null;
  descriere: string | null;
}

export interface AmortizareRaport {
  id: number;
  an: number;
  luna: number;
  valoareLunara: string;
  valoareCumulata: string;
  valoareRamasa: string;
}

// RAP-02: Balanta de Verificare
export interface BalantaRow {
  gestiuneId: number;
  gestiuneCod: string;
  gestiuneDenumire: string;
  numarActive: number;
  valoareInventar: string;
  valoareAmortizata: string;
  valoareRamasa: string;
}

export interface BalantaResponse {
  rows: BalantaRow[];
  totals: {
    numarActive: number;
    valoareInventar: string;
    valoareAmortizata: string;
    valoareRamasa: string;
  };
  filters: {
    stare?: string;
    clasificareCod?: string;
  };
}

// RAP-03: Jurnal Acte Operate
export interface JurnalActRow {
  id: number;
  mijlocFixId: number;
  numarInventar: string;
  denumireMijlocFix: string;
  tip: string;
  dataOperare: string;
  documentNumar: string | null;
  gestiuneSursaCod: string | null;
  gestiuneDestinatieCod: string | null;
  valoareOperatie: string | null;
  descriere: string | null;
}

export interface JurnalResponse {
  rows: JurnalActRow[];
  totals: {
    numarOperatii: number;
  };
  filters: {
    dataStart?: string;
    dataEnd?: string;
    gestiuneId?: number;
    tip?: string;
  };
}

// RAP-04: Situatie Amortizare Lunara
export interface SituatieAmortizareRow {
  mijlocFixId: number;
  numarInventar: string;
  denumire: string;
  gestiuneCod: string;
  clasificareCod: string;
  valoareInventar: string;
  valoareLunara: string;
  valoareCumulata: string;
  valoareRamasa: string;
}

export interface SituatieAmortizareResponse {
  rows: SituatieAmortizareRow[];
  totals: {
    valoareInventar: string;
    valoareLunara: string;
    valoareCumulata: string;
    valoareRamasa: string;
  };
  period: {
    an: number;
    luna: number;
  };
  filters: {
    gestiuneId?: number;
    clasificareCod?: string;
  };
}

// Filter parameters
export interface ReportFilters {
  dataStart?: string;
  dataEnd?: string;
  gestiuneId?: number;
  clasificareCod?: string;
  stare?: string;
}
```

Update packages/shared/src/index.ts to export all report types.
  </action>
  <verify>
- File exists at packages/shared/src/types/rapoarte.ts
- Types exported from packages/shared/src/index.ts
- TypeScript compiles: `cd packages/shared && bun run tsc --noEmit`
  </verify>
  <done>All report types defined and exported from shared package</done>
</task>

<task type="auto">
  <name>Task 2: Create report API endpoints</name>
  <files>
    packages/server/src/routes/rapoarte.ts
    packages/server/src/index.ts
  </files>
  <action>
Create packages/server/src/routes/rapoarte.ts with four endpoints:

**GET /fisa/:id** (RAP-01: Fisa Mijlocului Fix)
- Fetch asset with all joins (clasificare, gestiune, locFolosinta, sursaFinantare, cont, tipDocument)
- Fetch all transactions for asset with joins to gestiuni/locuri for source/destination names
- Fetch all depreciation records for asset ordered by an desc, luna desc
- Return FisaMijlocFix response
- 404 if asset not found

**GET /balanta** (RAP-02: Balanta de Verificare)
- Query params: stare (default 'activ'), clasificareCod (optional)
- Group by gestiune with aggregate sums:
  - COUNT(*) as numarActive
  - SUM(valoareInventar) as valoareInventar
  - SUM(valoareAmortizata) as valoareAmortizata
  - SUM(valoareRamasa) as valoareRamasa
- Calculate totals row
- Use Money class for decimal precision on totals
- Return BalantaResponse

**GET /jurnal** (RAP-03: Jurnal Acte Operate)
- Query params: dataStart, dataEnd (required), gestiuneId (optional), tip (optional)
- Validate date format (YYYY-MM-DD)
- Join tranzactii with mijloaceFixe for numarInventar/denumire
- Join with gestiuni for source/destination codes
- Filter by date range using between()
- Order by dataOperare desc
- Return JurnalResponse

**GET /amortizare** (RAP-04: Situatie Amortizare Lunara)
- Query params: an, luna (required), gestiuneId (optional), clasificareCod (optional)
- Join amortizari with mijloaceFixe, gestiuni, clasificari
- Filter by an/luna
- Calculate totals with Money class
- Return SituatieAmortizareResponse

Pattern for all endpoints:
- Use existing db, eq, and, sql imports
- Return { success: true, data: ... }
- Handle errors with { success: false, message: ... }
- All monetary values returned as strings (preserve precision)

Update packages/server/src/index.ts:
- Import rapoarteRoutes
- Register at /api/rapoarte
  </action>
  <verify>
Start server and test with curl:

```bash
# Fisa Mijlocului Fix (use a known asset ID)
curl http://localhost:3000/api/rapoarte/fisa/1 -b cookies.txt

# Balanta de Verificare
curl "http://localhost:3000/api/rapoarte/balanta?stare=activ" -b cookies.txt

# Jurnal Acte
curl "http://localhost:3000/api/rapoarte/jurnal?dataStart=2024-01-01&dataEnd=2024-12-31" -b cookies.txt

# Situatie Amortizare
curl "http://localhost:3000/api/rapoarte/amortizare?an=2024&luna=1" -b cookies.txt
```

All should return { success: true, data: ... } with appropriate structure.
  </verify>
  <done>
- GET /api/rapoarte/fisa/:id returns complete asset data with history
- GET /api/rapoarte/balanta returns grouped balance by gestiune
- GET /api/rapoarte/jurnal returns filtered transaction journal
- GET /api/rapoarte/amortizare returns monthly depreciation summary
- All endpoints support relevant filters
- All endpoints protected by auth middleware
  </done>
</task>

</tasks>

<verification>
1. Server running with `bun run dev`
2. Authenticate first (login via curl, save cookies)
3. Test each endpoint with sample data
4. Verify filtering works (gestiuneId, date range)
5. Verify totals are calculated correctly
6. Verify decimal precision maintained (no floating point errors)
</verification>

<success_criteria>
- [ ] All four report endpoints created and registered
- [ ] Fisa endpoint returns complete asset with transactions and depreciation
- [ ] Balanta endpoint groups by gestiune with correct totals
- [ ] Jurnal endpoint filters by date range
- [ ] Amortizare endpoint filters by year/month
- [ ] All endpoints support gestiuneId filter
- [ ] Shared types defined and used
- [ ] All endpoints protected by auth middleware
</success_criteria>

<output>
After completion, create `.planning/phases/06-rapoarte-autentificare/06-03-SUMMARY.md`
</output>
