---
phase: 06-rapoarte-autentificare
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/schema.ts
  - packages/server/src/routes/auth.ts
  - packages/server/src/middleware/auth.ts
  - packages/server/src/index.ts
  - packages/server/src/db/seed-user.ts
autonomous: true

must_haves:
  truths:
    - "User can login with valid credentials and receive a session"
    - "User receives 401 when credentials are invalid"
    - "Protected API routes reject unauthenticated requests"
    - "User can logout and session is invalidated"
  artifacts:
    - path: "packages/server/src/db/schema.ts"
      provides: "users table definition"
      contains: "users = mysqlTable"
    - path: "packages/server/src/routes/auth.ts"
      provides: "Login, logout, me endpoints"
      exports: ["authRoutes"]
    - path: "packages/server/src/middleware/auth.ts"
      provides: "JWT verification middleware"
      exports: ["authMiddleware"]
  key_links:
    - from: "packages/server/src/routes/auth.ts"
      to: "Bun.password"
      via: "password verification"
      pattern: "Bun\\.password\\.verify"
    - from: "packages/server/src/middleware/auth.ts"
      to: "hono/jwt"
      via: "token verification"
      pattern: "jwt.*cookie"
    - from: "packages/server/src/index.ts"
      to: "authMiddleware"
      via: "middleware registration"
      pattern: "app\\.use.*authMiddleware"
---

<objective>
Create authentication backend infrastructure: users table, auth API endpoints (login/logout/me), and JWT middleware to protect API routes.

Purpose: AUTH-01, AUTH-02, AUTH-03 - Enable secure access to the application with persistent sessions
Output: Working authentication API with password hashing, JWT tokens in HttpOnly cookies, and middleware protecting all existing API routes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-rapoarte-autentificare/06-RESEARCH.md

# Existing patterns
@packages/server/src/db/schema.ts
@packages/server/src/index.ts
@packages/server/src/routes/gestiuni.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add users table to schema and create seed script</name>
  <files>
    packages/server/src/db/schema.ts
    packages/server/src/db/seed-user.ts
  </files>
  <action>
Add users table to schema.ts following existing patterns:
```typescript
export const users = mysqlTable("users", {
  id: int("id").primaryKey().autoincrement(),
  username: varchar("username", { length: 100 }).notNull().unique(),
  passwordHash: varchar("password_hash", { length: 255 }).notNull(),
  activ: boolean("activ").default(true),
  createdAt: timestamp("created_at").notNull().default(sql`CURRENT_TIMESTAMP`),
  updatedAt: timestamp("updated_at").notNull().default(sql`CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP`),
});
```

Create seed-user.ts script that:
- Uses Bun.password.hash() with argon2id algorithm
- Creates default admin user (username: admin, password: admin123)
- Checks if user already exists before inserting
- Can be run via `bun run packages/server/src/db/seed-user.ts`

Run `bun run drizzle-kit push` to apply schema changes.
  </action>
  <verify>
- `bun run drizzle-kit push` completes without error
- `bun run packages/server/src/db/seed-user.ts` creates admin user
- Database contains users table with admin row (verify via mysql client or drizzle studio)
  </verify>
  <done>users table exists in database with passwordHash column, admin user seeded with hashed password</done>
</task>

<task type="auto">
  <name>Task 2: Create auth middleware and auth routes</name>
  <files>
    packages/server/src/middleware/auth.ts
    packages/server/src/routes/auth.ts
    packages/server/src/index.ts
  </files>
  <action>
Create middleware/auth.ts:
- Export authMiddleware using hono/jwt with cookie: "token"
- Use JWT_SECRET from process.env with fallback to "dev-secret-change-in-production"
- Skip auth for /api/auth/login and /api/auth/logout paths

Create routes/auth.ts with three endpoints:

POST /login:
- Accept { username, password } JSON body
- Query users table by username
- Use Bun.password.verify() to check password
- If valid: sign JWT with { sub: user.id, username: user.username, exp: 24h }
- Use setCookie() with httpOnly: true, secure: NODE_ENV === "production", sameSite: "Lax", path: "/", maxAge: 86400
- Return { success: true, data: { username } }
- If invalid: return 401 with { success: false, message: "Credentiale invalide" }

POST /logout:
- Use deleteCookie() to remove token cookie
- Return { success: true }

GET /me:
- Protected by auth middleware
- Extract user from JWT payload (c.get("jwtPayload"))
- Return { success: true, data: { username } }

Update index.ts:
- Import authMiddleware and authRoutes
- Apply authMiddleware to all /api/* routes EXCEPT /api/auth/* and /api/health
- Register authRoutes at /api/auth

Note: Use hono's built-in sign() from "hono/jwt" for token creation.
  </action>
  <verify>
Test with curl:
```bash
# Login with valid credentials
curl -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"username":"admin","password":"admin123"}' -c cookies.txt

# Should return success and Set-Cookie header

# Access protected route
curl http://localhost:3000/api/gestiuni -b cookies.txt
# Should return gestiuni list

# Access without cookie
curl http://localhost:3000/api/gestiuni
# Should return 401

# Logout
curl -X POST http://localhost:3000/api/auth/logout -b cookies.txt

# Verify /me endpoint
curl http://localhost:3000/api/auth/me -b cookies.txt
```
  </verify>
  <done>
- POST /api/auth/login returns 200 with Set-Cookie for valid credentials
- POST /api/auth/login returns 401 for invalid credentials
- GET /api/auth/me returns username when authenticated
- POST /api/auth/logout clears cookie
- All /api/* routes (except auth) return 401 without valid cookie
  </done>
</task>

</tasks>

<verification>
1. Run `bun run dev` in server package
2. Login via curl and receive token cookie
3. Access /api/gestiuni with cookie - returns data
4. Access /api/gestiuni without cookie - returns 401
5. Logout and verify cookie is cleared
6. /api/health remains accessible without auth (healthcheck for monitoring)
</verification>

<success_criteria>
- [ ] users table created with passwordHash column
- [ ] admin user seeded with Argon2id hashed password
- [ ] POST /api/auth/login validates credentials and sets HttpOnly cookie
- [ ] POST /api/auth/logout clears session cookie
- [ ] GET /api/auth/me returns current user
- [ ] All /api/* routes (except /api/auth/* and /api/health) require authentication
- [ ] 401 response for unauthenticated requests
</success_criteria>

<output>
After completion, create `.planning/phases/06-rapoarte-autentificare/06-01-SUMMARY.md`
</output>
