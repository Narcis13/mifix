---
phase: 03-mijloace-fixe-core
plan: 05
type: execute
wave: 4
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - packages/client/src/components/mijloace-fixe/MijlocFixForm.tsx
  - packages/client/src/pages/MijlocFixEdit.tsx
  - packages/client/src/main.tsx
autonomous: true

must_haves:
  truths:
    - "User can fill out registration form with all required fields"
    - "Form validates and shows errors in Romanian"
    - "Classification picker auto-fills durata normala"
    - "Duplicate numar inventar shows validation error"
    - "Form submits and creates new asset"
    - "Edit mode loads existing asset and updates"
  artifacts:
    - path: "packages/client/src/components/mijloace-fixe/MijlocFixForm.tsx"
      provides: "Multi-section asset form"
      min_lines: 200
    - path: "packages/client/src/pages/MijlocFixEdit.tsx"
      provides: "Create/Edit page wrapper"
      min_lines: 50
  key_links:
    - from: "MijlocFixForm.tsx"
      to: "/mijloace-fixe"
      via: "api.post or api.put on submit"
      pattern: "api\\.(post|put).*mijloace-fixe"
    - from: "MijlocFixForm.tsx"
      to: "ClasificarePicker"
      via: "onSelect callback setting durataNormala"
      pattern: "setValue.*durataNormala"
---

<objective>
Create the MijlocFix registration form with multi-section layout and create/edit page wrapper.

Purpose: Implements MF-01 (Inregistrare), MF-05 (Validare nr inventar unic), MF-06 (Selectare clasificare), and MF-04 (Editare).
Output: Fully functional asset form supporting both create and edit modes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-mijloace-fixe-core/03-CONTEXT.md
@.planning/phases/03-mijloace-fixe-core/03-RESEARCH.md
@packages/client/src/components/nomenclatoare/ConturiForm.tsx
@packages/client/src/components/nomenclatoare/LocuriForm.tsx
@packages/shared/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MijlocFixForm component</name>
  <files>packages/client/src/components/mijloace-fixe/MijlocFixForm.tsx</files>
  <action>
Create a large multi-section form at packages/client/src/components/mijloace-fixe/MijlocFixForm.tsx.

**Props:**
```typescript
interface MijlocFixFormProps {
  mijlocFix?: MijlocFix;  // Undefined = create mode, defined = edit mode
  onSuccess: () => void;
  onCancel: () => void;
}
```

**Form sections (using Card component for each):**

1. **Date Identificare**
   - numarInventar (Input, required)
   - denumire (Input, required)
   - descriere (Textarea, optional)
   - clasificareCod (ClasificarePicker, required)

2. **Document Intrare**
   - tipDocumentId (Select from /tipuri-document, optional)
   - documentAchizitie (Input - numar document, optional)
   - dataDocument (date Input, optional - use native date input)
   - furnizor (Input, optional)

3. **Date Contabile**
   - gestiuneId (Select from /gestiuni, required)
   - locFolosintaId (Select from /locuri?gestiuneId=X, optional - depends on gestiuneId)
   - contId (Select from /conturi, optional)
   - sursaFinantareId (Select from /surse-finantare, optional)

4. **Amortizare**
   - valoareInventar (Input type number, required) - show with "RON" suffix
   - dataAchizitie (date Input, required)
   - durataNormala (Input type number in months, required) - auto-filled from classification
   - eAmortizabil (Checkbox, default true)

**Implementation details:**

Use react-hook-form with zodResolver. Create client-side Zod schema (mirror server validation):

```typescript
const mijlocFixFormSchema = z.object({
  numarInventar: z.string().min(1, "Numar inventar obligatoriu").max(50),
  denumire: z.string().min(1, "Denumire obligatorie").max(255),
  descriere: z.string().max(1000).optional(),
  clasificareCod: z.string().min(1, "Clasificare obligatorie"),
  tipDocumentId: z.number().optional(),
  documentAchizitie: z.string().max(100).optional(),
  furnizor: z.string().max(200).optional(),
  gestiuneId: z.number().min(1, "Gestiune obligatorie"),
  locFolosintaId: z.number().optional(),
  contId: z.number().optional(),
  sursaFinantareId: z.number().optional(),
  valoareInventar: z.string().min(1, "Valoare obligatorie"),
  dataAchizitie: z.string().min(1, "Data achizitie obligatorie"),
  durataNormala: z.number().min(1, "Durata normala obligatorie"),
  eAmortizabil: z.boolean().default(true),
});
```

**Classification selection auto-fill:**

When classification is selected via ClasificarePicker:
1. Set clasificareCod to selected cod
2. Auto-fill durataNormala with classification's durataNormalaMin * 12 (convert years to months)
3. Show helper text: "Durata normala: {min}-{max} ani conform HG 2139/2004"

```typescript
const handleClasificareSelect = (clasificare: Clasificare) => {
  form.setValue("clasificareCod", clasificare.cod);
  form.setValue("durataNormala", clasificare.durataNormalaMin * 12);
  setSelectedClasificare(clasificare); // For displaying range info
};
```

**Gestiune -> LocFolosinta dependency:**

Use useWatch to monitor gestiuneId:
```typescript
const gestiuneId = useWatch({ control: form.control, name: "gestiuneId" });

useEffect(() => {
  if (gestiuneId) {
    // Fetch locuri for this gestiune
    api.get<LocFolosinta[]>(`/locuri?gestiuneId=${gestiuneId}`).then(/* ... */);
  }
  // Reset locFolosintaId when gestiune changes
  form.setValue("locFolosintaId", undefined);
}, [gestiuneId]);
```

**Submit handler:**

```typescript
const onSubmit = async (data: MijlocFixFormData) => {
  setIsSubmitting(true);

  // Compute derived fields for create
  const payload = {
    ...data,
    valoareInitiala: data.valoareInventar,
    valoareRamasa: data.valoareInventar,
    durataRamasa: data.durataNormala,
    cotaAmortizareLunara: (parseFloat(data.valoareInventar) / data.durataNormala).toFixed(2),
    stare: "activ",
  };

  const res = mijlocFix
    ? await api.put<MijlocFix>(`/mijloace-fixe/${mijlocFix.id}`, payload)
    : await api.post<MijlocFix>("/mijloace-fixe", payload);

  if (res.success) {
    onSuccess();
  } else if (res.errors) {
    // Set form errors from API response
    Object.entries(res.errors).forEach(([field, messages]) => {
      form.setError(field as keyof MijlocFixFormData, {
        message: messages[0],
      });
    });
  }

  setIsSubmitting(false);
};
```

**Edit mode:**

When mijlocFix prop is provided:
- form.reset() with existing values on mount
- Use useEffect to reset when mijlocFix.id changes (key form by id)
- Load related entities (gestiune, locuri, etc.) to populate selects

**Layout:**

```tsx
<form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
  <Card className="p-6">
    <h3 className="text-lg font-semibold mb-4">Date Identificare</h3>
    <Separator className="mb-4" />
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {/* Fields */}
    </div>
  </Card>

  {/* ... other sections ... */}

  <div className="flex justify-end gap-4">
    <Button type="button" variant="outline" onClick={onCancel}>
      Anuleaza
    </Button>
    <Button type="submit" disabled={isSubmitting}>
      {isSubmitting ? "Se salveaza..." : (mijlocFix ? "Salveaza" : "Adauga")}
    </Button>
  </div>
</form>
```
  </action>
  <verify>
1. Build succeeds: `bun run build` in packages/client
2. Form renders with 4 sections
3. Classification picker opens and auto-fills durata normala
4. Gestiune select triggers locuri refetch
5. Form validation shows errors on submit with empty fields
  </verify>
  <done>
- MijlocFixForm renders with 4 sections
- All required fields have validation
- Classification picker auto-fills durataNormala
- Gestiune->LocFolosinta dependency works
- Form supports both create and edit modes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MijlocFixEdit page and update routing</name>
  <files>
    packages/client/src/pages/MijlocFixEdit.tsx
    packages/client/src/main.tsx
  </files>
  <action>
**1. Create MijlocFixEdit.tsx** at packages/client/src/pages/:

This page wraps MijlocFixForm and handles:
- Determining create vs edit mode from URL
- Loading existing asset for edit mode
- Navigation after success

```typescript
import { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import type { MijlocFix } from "shared";
import { api } from "@/lib/api";
import { MijlocFixForm } from "@/components/mijloace-fixe/MijlocFixForm";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";

export function MijlocFixEdit() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const isEditMode = !!id;

  const [mijlocFix, setMijlocFix] = useState<MijlocFix | undefined>(undefined);
  const [isLoading, setIsLoading] = useState(isEditMode);

  useEffect(() => {
    if (id) {
      setIsLoading(true);
      api.get<MijlocFix>(`/mijloace-fixe/${id}`).then((res) => {
        if (res.success && res.data) {
          setMijlocFix(res.data);
        }
        setIsLoading(false);
      });
    }
  }, [id]);

  const handleSuccess = () => {
    // Navigate to detail page after create, or back to detail after edit
    if (isEditMode) {
      navigate(`/mijloace-fixe/${id}`);
    } else {
      navigate("/mijloace-fixe");
    }
  };

  const handleCancel = () => {
    navigate(-1); // Go back
  };

  if (isLoading) {
    return <div className="p-8">Se incarca...</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>
          <ArrowLeft className="h-4 w-4" />
        </Button>
        <div>
          <h1 className="text-2xl font-bold">
            {isEditMode ? "Editeaza Mijloc Fix" : "Adauga Mijloc Fix"}
          </h1>
          {isEditMode && mijlocFix && (
            <p className="text-muted-foreground">
              {mijlocFix.numarInventar} - {mijlocFix.denumire}
            </p>
          )}
        </div>
      </div>

      <MijlocFixForm
        key={id || "new"} // Key by id to reset form when navigating between assets
        mijlocFix={mijlocFix}
        onSuccess={handleSuccess}
        onCancel={handleCancel}
      />
    </div>
  );
}
```

**2. Update main.tsx** to use the real component:

Replace the placeholder with the actual import:

```typescript
import { MijlocFixEdit } from "./pages/MijlocFixEdit";

// In router config, the routes are already correct:
// path: "nou" -> element: <MijlocFixEdit />
// path: ":id/edit" -> element: <MijlocFixEdit />
```
  </action>
  <verify>
1. Navigate to /mijloace-fixe/nou - create form loads
2. Fill out all required fields, submit - creates asset, navigates to list
3. Navigate to /mijloace-fixe/{id}/edit - edit form loads with existing data
4. Change a field, submit - updates asset, navigates to detail
5. Duplicate numar inventar shows error "Numarul de inventar exista deja"
6. Back button works
  </verify>
  <done>
- Create mode at /mijloace-fixe/nou works
- Edit mode at /mijloace-fixe/:id/edit loads existing data
- Form submission creates/updates asset
- Navigation after success works correctly
- Validation errors display properly
  </done>
</task>

</tasks>

<verification>
1. Create flow: /mijloace-fixe -> click "Adauga" -> fill form -> submit -> asset created
2. Edit flow: /mijloace-fixe/:id -> click "Editeaza" -> change field -> submit -> asset updated
3. Classification picker auto-fills durataNormala
4. Gestiune selection filters locuri dropdown
5. Duplicate numarInventar shows validation error
6. All validation errors show in Romanian
</verification>

<success_criteria>
- Full asset registration form with 4 sections
- Create and edit modes both functional
- Classification picker with auto-fill
- Dependent dropdowns (gestiune->locuri)
- Server-side validation errors displayed
- Navigation flow complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-mijloace-fixe-core/03-05-SUMMARY.md`
</output>
