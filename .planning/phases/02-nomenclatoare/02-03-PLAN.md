---
phase: 02-nomenclatoare
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/server/src/routes/surse-finantare.ts
  - packages/server/src/routes/clasificari.ts
  - packages/server/src/index.ts
  - packages/client/src/pages/SurseFinantare.tsx
  - packages/client/src/pages/Clasificari.tsx
  - packages/client/src/components/nomenclatoare/SurseFinantareForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of surse finantare in a table"
    - "User can create/edit surse finantare via dialog"
    - "User can browse clasificari HG 2139/2004 catalog"
    - "User can search clasificari by cod or denumire"
  artifacts:
    - path: "packages/server/src/routes/surse-finantare.ts"
      provides: "Surse Finantare CRUD API"
      exports: ["surseFinantareRoutes"]
    - path: "packages/server/src/routes/clasificari.ts"
      provides: "Clasificari read-only API with search"
      exports: ["clasificariRoutes"]
    - path: "packages/client/src/pages/SurseFinantare.tsx"
      provides: "Surse Finantare list page"
      min_lines: 70
    - path: "packages/client/src/pages/Clasificari.tsx"
      provides: "Clasificari browse/search page"
      min_lines: 80
  key_links:
    - from: "packages/client/src/pages/Clasificari.tsx"
      to: "/api/clasificari"
      via: "api.get with search param"
      pattern: "api\\.get.*clasificari.*search"
    - from: "packages/server/src/routes/clasificari.ts"
      to: "packages/server/src/db/schema.ts"
      via: "Drizzle query with LIKE"
      pattern: "like.*search|ilike"
---

<objective>
Implement Surse Finantare CRUD (NOM-03) and Clasificari read-only browse with search (NOM-05).

Purpose: Surse Finantare follows same pattern as Gestiuni. Clasificari is read-only (preloaded HG 2139/2004 data) with search for selecting during asset registration.
Output: Working surse finantare management + clasificari catalog browser with search.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-nomenclatoare/02-RESEARCH.md
@.planning/phases/02-nomenclatoare/02-01-SUMMARY.md

@packages/server/src/db/schema.ts
@packages/server/src/validation/schemas.ts
@packages/server/src/routes/gestiuni.ts
@packages/client/src/pages/Gestiuni.tsx
@packages/client/src/components/nomenclatoare/GestiuniForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Surse Finantare API and UI</name>
  <files>
    packages/server/src/routes/surse-finantare.ts
    packages/server/src/index.ts
    packages/client/src/pages/SurseFinantare.tsx
    packages/client/src/components/nomenclatoare/SurseFinantareForm.tsx
  </files>
  <action>
    1. Create packages/server/src/routes/surse-finantare.ts:
       - Follow exact same pattern as gestiuni.ts
       - Endpoints: GET /, GET /:id, POST /, PUT /:id
       - Use insertSursaFinantareSchema for validation
       - Table columns: cod, denumire, activ

    2. Update packages/server/src/index.ts:
       - Import surseFinantareRoutes
       - Mount at /api/surse-finantare

    3. Create packages/client/src/components/nomenclatoare/SurseFinantareForm.tsx:
       - Dialog form for create/edit
       - Fields: cod (required), denumire (required), activ (checkbox)
       - Same pattern as GestiuniForm

    4. Update packages/client/src/pages/SurseFinantare.tsx:
       - Replace placeholder with full implementation
       - DataTable with columns: cod, denumire, activ, actions
       - "Adauga Sursa" button and edit functionality
       - Same pattern as Gestiuni page
  </action>
  <verify>
    - `bun run --cwd packages/server lint` passes
    - `curl http://localhost:3000/api/surse-finantare` returns empty array
    - `curl -X POST http://localhost:3000/api/surse-finantare -H "Content-Type: application/json" -d '{"cod":"BL","denumire":"Buget Local"}'` creates sursa
    - Navigate to http://localhost:5173/surse-finantare - shows table
    - Create and edit work via dialog
  </verify>
  <done>
    Surse Finantare CRUD fully working (API + UI).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Clasificari API (read-only with search) and UI</name>
  <files>
    packages/server/src/routes/clasificari.ts
    packages/server/src/index.ts
    packages/client/src/pages/Clasificari.tsx
  </files>
  <action>
    1. Create packages/server/src/routes/clasificari.ts:
       - Read-only endpoints (no POST/PUT - data is preloaded)

       GET /
       - Accept query params: ?search=, ?grupa=, ?page=, ?pageSize=
       - If search provided: filter by cod LIKE %search% OR denumire LIKE %search%
       - If grupa provided: filter by grupa = grupa
       - Paginate results (default pageSize=50)
       - Return PaginatedResponse<Clasificare>

       GET /:cod
       - Return single clasificare by cod (primary key)
       - 404 if not found

       Example:
       ```typescript
       import { Hono } from "hono";
       import { like, or, eq, sql } from "drizzle-orm";
       import { db } from "../db";
       import { clasificari } from "../db/schema";
       import type { ApiResponse, PaginatedResponse, Clasificare } from "shared";

       export const clasificariRoutes = new Hono();

       clasificariRoutes.get("/", async (c) => {
         const search = c.req.query("search");
         const grupa = c.req.query("grupa");
         const page = parseInt(c.req.query("page") || "1");
         const pageSize = parseInt(c.req.query("pageSize") || "50");

         let query = db.select().from(clasificari);

         const conditions = [];
         if (search) {
           conditions.push(or(
             like(clasificari.cod, `%${search}%`),
             like(clasificari.denumire, `%${search}%`)
           ));
         }
         if (grupa) {
           conditions.push(eq(clasificari.grupa, grupa));
         }

         // Count total for pagination
         const countResult = await db.select({ count: sql<number>`count(*)` })
           .from(clasificari)
           .where(conditions.length > 0 ? and(...conditions) : undefined);
         const total = countResult[0].count;

         // Get paginated results
         const items = await db.select()
           .from(clasificari)
           .where(conditions.length > 0 ? and(...conditions) : undefined)
           .limit(pageSize)
           .offset((page - 1) * pageSize)
           .orderBy(clasificari.cod);

         return c.json<ApiResponse<PaginatedResponse<Clasificare>>>({
           success: true,
           data: {
             items,
             total,
             page,
             pageSize,
             totalPages: Math.ceil(total / pageSize),
           },
         });
       });
       ```

    2. Update packages/server/src/index.ts:
       - Import clasificariRoutes
       - Mount at /api/clasificari

    3. Update packages/client/src/pages/Clasificari.tsx:
       - Replace placeholder with catalog browser
       - Search input at top (debounced 300ms)
       - Filter by grupa (dropdown: I, II, III)
       - DataTable with columns: cod, denumire, grupa, durataNormalaMin, durataNormalaMax
       - Pagination controls (prev/next, page indicator)
       - No create/edit buttons - read-only

       Example structure:
       ```typescript
       import { useState, useEffect, useCallback } from "react";
       import { DataTable } from "@/components/data-table/DataTable";
       import { Input } from "@/components/ui/input";
       import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
       import { Button } from "@/components/ui/button";
       import { api } from "@/lib/api";
       import type { Clasificare, PaginatedResponse } from "shared";

       // Debounce hook
       function useDebounce<T>(value: T, delay: number): T {
         const [debouncedValue, setDebouncedValue] = useState(value);
         useEffect(() => {
           const timer = setTimeout(() => setDebouncedValue(value), delay);
           return () => clearTimeout(timer);
         }, [value, delay]);
         return debouncedValue;
       }

       export function Clasificari() {
         const [search, setSearch] = useState("");
         const [grupa, setGrupa] = useState<string>("");
         const [page, setPage] = useState(1);
         const [data, setData] = useState<PaginatedResponse<Clasificare> | null>(null);
         const debouncedSearch = useDebounce(search, 300);

         const loadData = useCallback(async () => {
           const params = new URLSearchParams();
           if (debouncedSearch) params.set("search", debouncedSearch);
           if (grupa) params.set("grupa", grupa);
           params.set("page", page.toString());

           const res = await api.get<PaginatedResponse<Clasificare>>(`/clasificari?${params}`);
           if (res.success && res.data) setData(res.data);
         }, [debouncedSearch, grupa, page]);

         useEffect(() => { loadData(); }, [loadData]);

         // Reset to page 1 when search/filter changes
         useEffect(() => { setPage(1); }, [debouncedSearch, grupa]);

         // ... render search, filter, DataTable, pagination
       }
       ```
  </action>
  <verify>
    - `bun run --cwd packages/server lint` passes
    - `curl "http://localhost:3000/api/clasificari?pageSize=10"` returns paginated response
    - `curl "http://localhost:3000/api/clasificari?search=calculator"` returns filtered results
    - Navigate to http://localhost:5173/clasificari - shows catalog
    - Type in search - results filter as you type (debounced)
    - Select grupa filter - results filter by grupa
    - Pagination works: next/prev buttons, page indicator updates
  </verify>
  <done>
    Clasificari catalog browser working with search and pagination. Read-only as specified.
  </done>
</task>

</tasks>

<verification>
1. Surse Finantare API works:
   - GET /api/surse-finantare returns list
   - POST creates new sursa
   - PUT updates sursa
2. Surse Finantare UI works:
   - Page shows table, create/edit dialogs work
3. Clasificari API works:
   - GET /api/clasificari returns paginated results
   - ?search= filters by cod or denumire
   - ?grupa= filters by grupa
   - Pagination works
4. Clasificari UI works:
   - Search input filters results
   - Grupa dropdown filters results
   - Pagination controls work
5. No TypeScript errors
</verification>

<success_criteria>
- NOM-03 complete: Surse Finantare CRUD working
- NOM-05 complete: Clasificari catalog browsable with search
- Both pages follow consistent UI patterns established in 02-02
- Search debounced to avoid excessive API calls
</success_criteria>

<output>
After completion, create `.planning/phases/02-nomenclatoare/02-03-SUMMARY.md`
</output>
