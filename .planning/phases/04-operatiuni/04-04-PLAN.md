---
phase: 04-operatiuni
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - packages/client/src/components/operatiuni/TranzactiiTimeline.tsx
  - packages/client/src/pages/MijlocFixDetail.tsx
  - packages/server/src/routes/operatiuni.ts
autonomous: false

must_haves:
  truths:
    - "User can view complete transaction history for any asset"
    - "Transaction history shows operation type, date, and relevant details"
    - "User can access operation dialogs from asset detail page"
    - "Asset detail page refreshes after any operation completes"
  artifacts:
    - path: "packages/client/src/components/operatiuni/TranzactiiTimeline.tsx"
      provides: "Timeline component displaying transaction history"
      min_lines: 80
    - path: "packages/client/src/pages/MijlocFixDetail.tsx"
      provides: "Extended detail page with operations section and history"
  key_links:
    - from: "packages/client/src/pages/MijlocFixDetail.tsx"
      to: "packages/client/src/components/operatiuni/*Dialog.tsx"
      via: "Dialog components with open state and onSuccess"
      pattern: "Dialog.*open.*onSuccess"
    - from: "packages/client/src/components/operatiuni/TranzactiiTimeline.tsx"
      to: "/api/operatiuni/istoric"
      via: "fetch transaction history"
      pattern: "/operatiuni/istoric"
---

<objective>
Create transaction history timeline component and integrate all operations into asset detail page

Purpose: Enable users to view complete audit trail (OP-05) and access all asset operations from a unified interface on the asset detail page.

Output:
- TranzactiiTimeline.tsx - Timeline component showing transaction history
- GET /api/operatiuni/istoric/:mijlocFixId endpoint for fetching history
- Updated MijlocFixDetail.tsx with operations section and history display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-operatiuni/04-RESEARCH.md
@.planning/phases/04-operatiuni/04-02-SUMMARY.md
@.planning/phases/04-operatiuni/04-03-SUMMARY.md

# Key files
@packages/client/src/pages/MijlocFixDetail.tsx
@packages/server/src/routes/operatiuni.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transaction history API endpoint</name>
  <files>
    packages/server/src/routes/operatiuni.ts
  </files>
  <action>
Add to packages/server/src/routes/operatiuni.ts:

1. GET /istoric/:mijlocFixId endpoint:
   - Parse mijlocFixId from params
   - Query tranzactii table with LEFT JOINs:
     - gestiuneSursa (gestiuni alias)
     - gestiuneDestinatie (gestiuni alias)
     - locFolosintaSursa (locuriUilizare alias)
     - locFolosintaDestinatie (locuriUilizare alias)
   - Order by dataOperare DESC, then createdAt DESC (newest first)
   - Return array of tranzactii with populated relations

2. Response shape:
   ```typescript
   {
     success: true,
     data: Tranzactie[] // with populated gestiuneSursa, gestiuneDestinatie, locFolosintaSursa, locFolosintaDestinatie
   }
   ```

Use existing LEFT JOIN pattern from mijloace-fixe.ts for relation population.
  </action>
  <verify>
Test with curl:
curl http://localhost:3001/api/operatiuni/istoric/1

Should return { success: true, data: [...] } with transaction records (if any exist for that asset).
  </verify>
  <done>
GET /api/operatiuni/istoric/:mijlocFixId endpoint returns transaction history with populated relations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TranzactiiTimeline component</name>
  <files>
    packages/client/src/components/operatiuni/TranzactiiTimeline.tsx
  </files>
  <action>
Create packages/client/src/components/operatiuni/TranzactiiTimeline.tsx:

1. Props interface:
   ```typescript
   interface TranzactiiTimelineProps {
     mijlocFixId: number;
   }
   ```

2. Type mappings:
   ```typescript
   const tipLabels: Record<TipTranzactie, string> = {
     intrare: "Intrare",
     transfer: "Transfer",
     casare: "Casare",
     declasare: "Declasare",
     reevaluare: "Reevaluare",
     modernizare: "Modernizare",
     iesire: "Iesire",
   };

   const tipIcons: Record<TipTranzactie, ReactNode> = {
     intrare: <Plus className="h-4 w-4" />,
     transfer: <ArrowRightLeft className="h-4 w-4" />,
     casare: <Ban className="h-4 w-4" />,
     declasare: <TrendingDown className="h-4 w-4" />,
     reevaluare: <RefreshCw className="h-4 w-4" />,
     modernizare: <Wrench className="h-4 w-4" />,
     iesire: <LogOut className="h-4 w-4" />,
   };
   ```

3. Component implementation:
   - useState for tranzactii array, isLoading
   - useEffect to fetch tranzactii from /api/operatiuni/istoric/:mijlocFixId
   - Handle loading state and empty state

4. Timeline UI structure:
   - Vertical line on the left (absolute positioned)
   - Each tranzactie as a timeline item:
     - Icon in circle on the left
     - Card on the right with:
       - Header: tipLabels[tip] + date (formatted ro-RO)
       - Body: Details based on tip:
         - transfer: "De la {gestiuneSursa} la {gestiuneDestinatie}" or loc change
         - casare: descriere (motivation)
         - declasare: "Reducere: {valoareOperatie} RON" + descriere
         - Other types: descriere or observatii if present
       - Footer (optional): documentNumar if present

5. Empty state:
   - Show message "Nu exista tranzactii inregistrate" with History icon

6. Loading state:
   - Show skeleton or loading message

Import icons from lucide-react: Plus, ArrowRightLeft, Ban, TrendingDown, RefreshCw, Wrench, LogOut, History
  </action>
  <verify>
TypeScript compiles without errors: `cd packages/client && bun run build`
  </verify>
  <done>
TranzactiiTimeline component created with vertical timeline layout, icons per operation type, details display, and empty/loading states.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate operations and history into MijlocFixDetail page</name>
  <files>
    packages/client/src/pages/MijlocFixDetail.tsx
  </files>
  <action>
Update packages/client/src/pages/MijlocFixDetail.tsx:

1. Add imports:
   - TransferGestiuneDialog, TransferLocDialog, CasareDialog, DeclasareDialog from components/operatiuni
   - TranzactiiTimeline from components/operatiuni
   - DropdownMenu components from ui/dropdown-menu
   - Icons: MoreHorizontal, ArrowRightLeft, MapPin, Ban, TrendingDown, History

2. Add state for dialogs:
   ```typescript
   const [transferGestiuneOpen, setTransferGestiuneOpen] = useState(false);
   const [transferLocOpen, setTransferLocOpen] = useState(false);
   const [casareOpen, setCasareOpen] = useState(false);
   const [declasareOpen, setDeclasareOpen] = useState(false);
   ```

3. Add refresh function:
   ```typescript
   const refreshData = () => {
     // Re-fetch mijlocFix data
     setIsLoading(true);
     api.get<MijlocFix>(`/mijloace-fixe/${id}`).then((res) => {
       if (res.success && res.data) {
         setMijlocFix(res.data);
       }
       setIsLoading(false);
     });
   };
   ```

4. Update header section to add Operations dropdown (only for active assets):
   After the Edit button, add:
   ```tsx
   {mijlocFix.stare === "activ" && (
     <DropdownMenu>
       <DropdownMenuTrigger asChild>
         <Button variant="outline">
           Operatiuni <MoreHorizontal className="ml-2 h-4 w-4" />
         </Button>
       </DropdownMenuTrigger>
       <DropdownMenuContent align="end">
         <DropdownMenuItem onClick={() => setTransferGestiuneOpen(true)}>
           <ArrowRightLeft className="mr-2 h-4 w-4" />
           Transfer Gestiune
         </DropdownMenuItem>
         <DropdownMenuItem onClick={() => setTransferLocOpen(true)}>
           <MapPin className="mr-2 h-4 w-4" />
           Transfer Loc Folosinta
         </DropdownMenuItem>
         <DropdownMenuSeparator />
         <DropdownMenuItem onClick={() => setDeclasareOpen(true)}>
           <TrendingDown className="mr-2 h-4 w-4" />
           Declasare
         </DropdownMenuItem>
         <DropdownMenuItem onClick={() => setCasareOpen(true)} className="text-destructive">
           <Ban className="mr-2 h-4 w-4" />
           Casare
         </DropdownMenuItem>
       </DropdownMenuContent>
     </DropdownMenu>
   )}
   ```

5. Add new section at the end: "Istoric Tranzactii"
   ```tsx
   <Card>
     <CardHeader>
       <CardTitle className="flex items-center gap-2">
         <History className="h-5 w-5" />
         Istoric Tranzactii
       </CardTitle>
     </CardHeader>
     <CardContent>
       <TranzactiiTimeline mijlocFixId={mijlocFix.id} />
     </CardContent>
   </Card>
   ```

6. Add dialog components at the end of the return statement:
   ```tsx
   {mijlocFix && (
     <>
       <TransferGestiuneDialog
         open={transferGestiuneOpen}
         onOpenChange={setTransferGestiuneOpen}
         mijlocFix={mijlocFix}
         onSuccess={refreshData}
       />
       <TransferLocDialog
         open={transferLocOpen}
         onOpenChange={setTransferLocOpen}
         mijlocFix={mijlocFix}
         onSuccess={refreshData}
       />
       <CasareDialog
         open={casareOpen}
         onOpenChange={setCasareOpen}
         mijlocFix={mijlocFix}
         onSuccess={refreshData}
       />
       <DeclasareDialog
         open={declasareOpen}
         onOpenChange={setDeclasareOpen}
         mijlocFix={mijlocFix}
         onSuccess={refreshData}
       />
     </>
   )}
   ```

7. Add DropdownMenu shadcn component if not already installed:
   Check if exists: packages/client/src/components/ui/dropdown-menu.tsx
   If not, run: `cd packages/client && bunx shadcn@latest add dropdown-menu`
  </action>
  <verify>
1. Start dev server: `bun run dev`
2. Navigate to asset detail page: http://localhost:5173/mijloace-fixe/1
3. Verify:
   - "Operatiuni" dropdown appears for active assets
   - Operations dropdown has four items
   - "Istoric Tranzactii" section appears at bottom
   - Clicking operations opens respective dialogs
  </verify>
  <done>
MijlocFixDetail page updated with Operations dropdown menu, all four operation dialogs, transaction history section, and data refresh after operations.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete asset operations functionality:
- Transfer between gestiuni (OP-01)
- Transfer within gestiune to different loc folosinta (OP-02)
- Casare/disposal (OP-03)
- Declasare/value reduction (OP-04)
- Transaction history display (OP-05)
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:5173/mijloace-fixe
2. Select an active asset (stare = "activ")
3. Test Transfer Gestiune:
   - Click "Operatiuni" dropdown
   - Select "Transfer Gestiune"
   - Select a different gestiune and optionally a loc folosinta
   - Fill in date and optional fields
   - Click "Transfera"
   - Verify: Toast shows success, page refreshes, gestiune changed

4. Test Transfer Loc Folosinta:
   - Click "Operatiuni" -> "Transfer Loc Folosinta"
   - Select a different loc folosinta within same gestiune
   - Submit and verify loc changed

5. Test Declasare:
   - Click "Operatiuni" -> "Declasare"
   - Enter a reduction amount (must be <= valoare ramasa)
   - Enter motivation
   - Submit and verify valoare ramasa reduced

6. Test Casare:
   - Click "Operatiuni" -> "Casare" (on a different asset)
   - Note the warning message
   - Enter motivation
   - Submit and verify stare changed to "casare"
   - Verify "Operatiuni" dropdown no longer appears for casat asset

7. Verify Istoric Tranzactii:
   - Scroll to "Istoric Tranzactii" section
   - Verify all operations appear in timeline
   - Check details: dates, gestiune names, values

8. Test validation:
   - Try declasare with amount > remaining value
   - Try submitting forms with missing required fields
  </how-to-verify>
  <resume-signal>Type "approved" if all operations work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. GET /api/operatiuni/istoric/:id returns transaction history with relations
2. TranzactiiTimeline displays transactions chronologically with correct icons
3. MijlocFixDetail has Operatiuni dropdown for active assets only
4. All four operation dialogs open and close correctly
5. Operations update asset and create transaction records
6. Page refreshes automatically after successful operation
7. Validation prevents invalid operations (e.g., excessive declasare)
</verification>

<success_criteria>
- User can perform all four operation types from asset detail page
- Transaction history shows all operations with type-specific details
- Operations dropdown only appears for active assets
- Data refreshes after each successful operation
- All Phase 4 requirements (OP-01 through OP-05) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-operatiuni/04-04-SUMMARY.md`
</output>
