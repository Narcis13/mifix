---
phase: 04-operatiuni
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/client/src/components/operatiuni/TransferGestiuneDialog.tsx
  - packages/client/src/components/operatiuni/TransferLocDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can transfer asset to different gestiune via dialog"
    - "User can transfer asset to different loc folosinta within same gestiune"
    - "Destination gestiune selection filters available locuri folosinta"
    - "Transfer dialogs show current asset info (numarInventar, denumire, current gestiune/loc)"
  artifacts:
    - path: "packages/client/src/components/operatiuni/TransferGestiuneDialog.tsx"
      provides: "Dialog for transfer between gestiuni with gestiune/loc selection"
      min_lines: 100
    - path: "packages/client/src/components/operatiuni/TransferLocDialog.tsx"
      provides: "Dialog for transfer within gestiune to different loc folosinta"
      min_lines: 80
  key_links:
    - from: "packages/client/src/components/operatiuni/TransferGestiuneDialog.tsx"
      to: "/api/operatiuni/transfer-gestiune"
      via: "api.post on form submit"
      pattern: "api\\.post.*transfer-gestiune"
    - from: "packages/client/src/components/operatiuni/TransferGestiuneDialog.tsx"
      to: "/api/locuri"
      via: "fetch locuri filtered by gestiuneDestinatieId"
      pattern: "/locuri\\?gestiuneId="
---

<objective>
Create transfer dialog components for asset transfers between gestiuni and within gestiune

Purpose: Enable users to perform OP-01 (transfer between gestiuni) and OP-02 (transfer within gestiune to different loc folosinta) through intuitive dialog forms.

Output:
- TransferGestiuneDialog.tsx - Dialog for transferring asset to different gestiune
- TransferLocDialog.tsx - Dialog for transferring asset to different loc folosinta within same gestiune
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-operatiuni/04-RESEARCH.md

# Key patterns from existing code
@packages/client/src/components/gestiuni/GestiuniForm.tsx
@packages/client/src/pages/MijlocFixForm.tsx
@packages/client/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TransferGestiuneDialog component</name>
  <files>
    packages/client/src/components/operatiuni/TransferGestiuneDialog.tsx
  </files>
  <action>
Create packages/client/src/components/operatiuni/TransferGestiuneDialog.tsx:

1. Props interface:
   ```typescript
   interface TransferGestiuneDialogProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     mijlocFix: MijlocFix;
     onSuccess: () => void;
   }
   ```

2. Form schema (inline Zod):
   ```typescript
   const formSchema = z.object({
     gestiuneDestinatieId: z.number().min(1, "Selectati gestiunea destinatie"),
     locFolosintaDestinatieId: z.number().nullable(),
     dataOperare: z.string().min(1, "Data obligatorie"),
     documentNumar: z.string().max(100).optional(),
     observatii: z.string().max(500).optional(),
   });
   ```

3. Component implementation:
   - useState for gestiuni list, locuriDestinatie list, isSubmitting
   - useForm with zodResolver
   - useEffect to load all active gestiuni on mount (exclude current gestiune)
   - useWatch on gestiuneDestinatieId to dynamically load locuri for that gestiune
   - Clear locFolosintaDestinatieId when gestiune changes

4. Dialog structure:
   - DialogHeader: "Transfer Gestiune"
   - DialogDescription: Show current info - "{mijlocFix.numarInventar} - {mijlocFix.denumire}"
   - Show current gestiune: "Gestiune curenta: {mijlocFix.gestiune?.denumire}"

5. Form fields:
   - Gestiune Destinatie (Select, required) - list of active gestiuni except current
   - Loc Folosinta Destinatie (Select, optional) - filtered by selected gestiune
   - Data Operare (Input type="date", required, default today)
   - Document Nr. (Input, optional)
   - Observatii (Textarea, optional)

6. Submit handler:
   - Call api.post("/operatiuni/transfer-gestiune", { mijlocFixId: mijlocFix.id, ...formData })
   - On success: show toast "Transfer efectuat cu succes", call onSuccess(), close dialog
   - On error: show toast with error message

7. Footer:
   - Anuleaza button (variant="outline", closes dialog)
   - Transfera button (type="submit", disabled while submitting)

Use existing patterns from GestiuniForm.tsx for dialog structure and MijlocFixForm.tsx for useWatch pattern with locuri.
  </action>
  <verify>
TypeScript compiles without errors: `cd packages/client && bun run build`
  </verify>
  <done>
TransferGestiuneDialog component created with gestiune selection, dependent loc folosinta selection, form validation, and API integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TransferLocDialog component</name>
  <files>
    packages/client/src/components/operatiuni/TransferLocDialog.tsx
  </files>
  <action>
Create packages/client/src/components/operatiuni/TransferLocDialog.tsx:

1. Props interface:
   ```typescript
   interface TransferLocDialogProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     mijlocFix: MijlocFix;
     onSuccess: () => void;
   }
   ```

2. Form schema (inline Zod):
   ```typescript
   const formSchema = z.object({
     locFolosintaDestinatieId: z.number().min(1, "Selectati locul de folosinta"),
     dataOperare: z.string().min(1, "Data obligatorie"),
     documentNumar: z.string().max(100).optional(),
     observatii: z.string().max(500).optional(),
   });
   ```

3. Component implementation:
   - useState for locuri list (filtered by mijlocFix.gestiuneId), isSubmitting
   - useForm with zodResolver
   - useEffect to load locuri for current gestiune on mount (exclude current loc)

4. Dialog structure:
   - DialogHeader: "Transfer Loc Folosinta"
   - DialogDescription: "{mijlocFix.numarInventar} - {mijlocFix.denumire}"
   - Show current info:
     - "Gestiune: {mijlocFix.gestiune?.denumire}" (readonly info)
     - "Loc curent: {mijlocFix.locFolosinta?.denumire || 'Nespecificat'}"

5. Form fields:
   - Loc Folosinta Destinatie (Select, required) - locuri in same gestiune, exclude current
   - Data Operare (Input type="date", required, default today)
   - Document Nr. (Input, optional)
   - Observatii (Textarea, optional)

6. Submit handler:
   - Call api.post("/operatiuni/transfer-loc", { mijlocFixId: mijlocFix.id, ...formData })
   - On success: show toast "Transfer efectuat cu succes", call onSuccess(), close dialog
   - On error: show toast with error message

7. Footer:
   - Anuleaza button (variant="outline", closes dialog)
   - Transfera button (type="submit", disabled while submitting)

Note: This is simpler than TransferGestiuneDialog since gestiune doesn't change - only loc folosinta within same gestiune.
  </action>
  <verify>
TypeScript compiles without errors: `cd packages/client && bun run build`
  </verify>
  <done>
TransferLocDialog component created with loc folosinta selection (filtered by current gestiune), form validation, and API integration.
  </done>
</task>

</tasks>

<verification>
1. TransferGestiuneDialog renders without errors
2. TransferLocDialog renders without errors
3. Gestiune dropdown excludes current gestiune in TransferGestiuneDialog
4. Loc folosinta dropdown updates when gestiune changes in TransferGestiuneDialog
5. Loc folosinta dropdown in TransferLocDialog shows only locuri from same gestiune
6. Form validation shows errors for missing required fields
7. TypeScript compiles without errors
</verification>

<success_criteria>
- TransferGestiuneDialog allows selecting destination gestiune and optional loc folosinta
- TransferLocDialog allows selecting destination loc folosinta within same gestiune
- Both dialogs show current asset info and submit to correct API endpoints
- Success callback triggers UI refresh
- Form validation works with Romanian error messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-operatiuni/04-02-SUMMARY.md`
</output>
