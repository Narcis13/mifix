---
phase: 04-operatiuni
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/client/src/components/operatiuni/CasareDialog.tsx
  - packages/client/src/components/operatiuni/DeclasareDialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can mark asset as disposed (casat) with required motivation"
    - "User can perform value reduction (declasare) on asset with amount and motivation"
    - "Declasare validates that reduction amount doesn't exceed remaining value"
    - "Both dialogs show current asset info before operation"
  artifacts:
    - path: "packages/client/src/components/operatiuni/CasareDialog.tsx"
      provides: "Dialog for asset disposal with motivation field"
      min_lines: 80
    - path: "packages/client/src/components/operatiuni/DeclasareDialog.tsx"
      provides: "Dialog for value reduction with amount and motivation"
      min_lines: 100
  key_links:
    - from: "packages/client/src/components/operatiuni/CasareDialog.tsx"
      to: "/api/operatiuni/casare"
      via: "api.post on form submit"
      pattern: "api\\.post.*casare"
    - from: "packages/client/src/components/operatiuni/DeclasareDialog.tsx"
      to: "/api/operatiuni/declasare"
      via: "api.post on form submit"
      pattern: "api\\.post.*declasare"
---

<objective>
Create casare and declasare dialog components for asset disposal and value reduction

Purpose: Enable users to perform OP-03 (casare - mark asset as disposed) and OP-04 (declasare - reduce asset value) through dialog forms with proper documentation.

Output:
- CasareDialog.tsx - Dialog for marking asset as disposed with motivation
- DeclasareDialog.tsx - Dialog for performing value reduction with amount and motivation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-operatiuni/04-RESEARCH.md

# Key patterns from existing code
@packages/client/src/components/gestiuni/GestiuniForm.tsx
@packages/shared/src/money.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CasareDialog component</name>
  <files>
    packages/client/src/components/operatiuni/CasareDialog.tsx
  </files>
  <action>
Create packages/client/src/components/operatiuni/CasareDialog.tsx:

1. Props interface:
   ```typescript
   interface CasareDialogProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     mijlocFix: MijlocFix;
     onSuccess: () => void;
   }
   ```

2. Form schema (inline Zod):
   ```typescript
   const formSchema = z.object({
     motivCasare: z.string().min(1, "Motivul casarii este obligatoriu").max(500),
     dataOperare: z.string().min(1, "Data obligatorie"),
     documentNumar: z.string().max(100).optional(),
     observatii: z.string().max(500).optional(),
   });
   ```

3. Component implementation:
   - useState for isSubmitting
   - useForm with zodResolver, defaultValues with today's date for dataOperare

4. Dialog structure:
   - DialogHeader: "Casare Mijloc Fix"
   - DialogDescription: "{mijlocFix.numarInventar} - {mijlocFix.denumire}"
   - Warning Alert: Show destructive alert explaining that casare is irreversible
     "Atentie: Casarea marcheaza mijlocul fix ca scos din functiune. Aceasta operatie nu poate fi anulata."

5. Asset info display (read-only):
   - Valoare inventar: {formatCurrency(mijlocFix.valoareInventar)}
   - Valoare ramasa: {formatCurrency(mijlocFix.valoareRamasa)}
   - Gestiune: {mijlocFix.gestiune?.denumire}

6. Form fields:
   - Motiv Casare (Textarea, required, placeholder: "Descrieti motivul casarii...")
   - Data Operare (Input type="date", required, default today)
   - Document Nr. (Input, optional)
   - Observatii (Textarea, optional)

7. Submit handler:
   - Call api.post("/operatiuni/casare", { mijlocFixId: mijlocFix.id, ...formData })
   - On success: show toast "Casare efectuata cu succes", call onSuccess(), close dialog
   - On error: show toast with error message

8. Footer:
   - Anuleaza button (variant="outline", closes dialog)
   - Confirma Casare button (variant="destructive", type="submit", disabled while submitting)

Include formatCurrency helper function for monetary display.
  </action>
  <verify>
TypeScript compiles without errors: `cd packages/client && bun run build`
  </verify>
  <done>
CasareDialog component created with warning alert, asset info display, motivation field, and API integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DeclasareDialog component</name>
  <files>
    packages/client/src/components/operatiuni/DeclasareDialog.tsx
  </files>
  <action>
Create packages/client/src/components/operatiuni/DeclasareDialog.tsx:

1. Props interface:
   ```typescript
   interface DeclasareDialogProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     mijlocFix: MijlocFix;
     onSuccess: () => void;
   }
   ```

2. Form schema (inline Zod with superRefine for validation):
   ```typescript
   const createFormSchema = (valoareRamasa: string) => z.object({
     valoareReducere: z.string().min(1, "Valoarea reducerii este obligatorie"),
     motivDeclasare: z.string().min(1, "Motivul declasarii este obligatoriu").max(500),
     dataOperare: z.string().min(1, "Data obligatorie"),
     documentNumar: z.string().max(100).optional(),
     observatii: z.string().max(500).optional(),
   }).superRefine((data, ctx) => {
     const reducere = parseFloat(data.valoareReducere);
     const ramasa = parseFloat(valoareRamasa);
     if (isNaN(reducere) || reducere <= 0) {
       ctx.addIssue({
         code: z.ZodIssueCode.custom,
         message: "Introduceti o valoare pozitiva",
         path: ["valoareReducere"],
       });
     }
     if (reducere > ramasa) {
       ctx.addIssue({
         code: z.ZodIssueCode.custom,
         message: `Reducerea nu poate depasi valoarea ramasa (${formatCurrency(valoareRamasa)})`,
         path: ["valoareReducere"],
       });
     }
   });
   ```

3. Component implementation:
   - useState for isSubmitting
   - useMemo to create form schema with current valoareRamasa
   - useForm with zodResolver
   - Watch valoareReducere to calculate and show preview of new valoareRamasa

4. Dialog structure:
   - DialogHeader: "Declasare Mijloc Fix"
   - DialogDescription: "{mijlocFix.numarInventar} - {mijlocFix.denumire}"
   - Info Alert: "Declasarea reduce valoarea ramasa a mijlocului fix."

5. Asset info display (read-only):
   - Valoare inventar: {formatCurrency(mijlocFix.valoareInventar)}
   - Valoare ramasa curenta: {formatCurrency(mijlocFix.valoareRamasa)}

6. Form fields:
   - Valoare Reducere (Input type="number", required, step="0.01", min="0.01")
   - Preview: Show calculated new valoareRamasa after reduction (if valid input)
   - Motiv Declasare (Textarea, required, placeholder: "Descrieti motivul declasarii...")
   - Data Operare (Input type="date", required, default today)
   - Document Nr. (Input, optional)
   - Observatii (Textarea, optional)

7. Submit handler:
   - Call api.post("/operatiuni/declasare", { mijlocFixId: mijlocFix.id, ...formData })
   - On success: show toast "Declasare efectuata cu succes", call onSuccess(), close dialog
   - On error: show toast with error message

8. Footer:
   - Anuleaza button (variant="outline", closes dialog)
   - Confirma Declasare button (type="submit", disabled while submitting)

Include formatCurrency helper function for monetary display.
  </action>
  <verify>
TypeScript compiles without errors: `cd packages/client && bun run build`
  </verify>
  <done>
DeclasareDialog component created with value reduction input, validation against remaining value, preview of new value, motivation field, and API integration.
  </done>
</task>

</tasks>

<verification>
1. CasareDialog renders without errors and shows warning alert
2. DeclasareDialog renders without errors
3. CasareDialog requires motivation field
4. DeclasareDialog validates reduction amount doesn't exceed remaining value
5. DeclasareDialog shows preview of new remaining value
6. Both dialogs submit to correct API endpoints
7. TypeScript compiles without errors
</verification>

<success_criteria>
- CasareDialog displays warning, requires motivation, and marks asset as disposed
- DeclasareDialog requires reduction amount and motivation
- DeclasareDialog validates reduction <= remaining value with Romanian error message
- DeclasareDialog shows calculated new remaining value before confirmation
- Success callback triggers UI refresh
</success_criteria>

<output>
After completion, create `.planning/phases/04-operatiuni/04-03-SUMMARY.md`
</output>
